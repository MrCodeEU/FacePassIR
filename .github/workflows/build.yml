name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build (Linux/amd64)
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    env:
      GO111MODULE: on
      CGO_ENABLED: '1'
      CC: gcc
      CXX: g++
      GOOS: linux
      GOARCH: amd64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ${{ github.workspace }}/bin
          ${{ github.workspace }}/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install system dependencies (Debian/Ubuntu)
      run: |
        set -eux
        sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          apt-utils ca-certificates curl gnupg lsb-release \
          build-essential cmake pkg-config git tar g++ \
          libatlas-base-dev liblapack-dev libjpeg-dev libpam0g-dev libdlib-dev \
          rpm fakeroot dpkg-dev \
          libx11-dev libxcb1-dev
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Display build info
      run: |
        go version
        gcc --version
        g++ --version

    - name: Build (CGO enabled)
      run: |
        make clean || true
        env CGO_ENABLED=1 CC=gcc CXX=g++ make build

    - name: Run unit tests
      run: |
        # Limit race & coverage style tests to non-hardware dependent packages
        go test -v ./pkg/... -count=1

    - name: Create Tarball
      run: |
        mkdir -p dist/facepass/bin
        cp bin/facepass dist/facepass/bin/
        cp bin/facepass-pam dist/facepass/bin/
        cp scripts/install.sh dist/facepass/
        cp scripts/uninstall.sh dist/facepass/
        cp -r configs dist/facepass/
        cp README.md dist/facepass/
        cp LICENSE dist/facepass/
        # Create a small wrapper install
        cat > dist/facepass/install.sh <<'EOF'
        #!/usr/bin/env bash
        set -euo pipefail
        cd "$(dirname "$0")"
        sudo ./scripts/install.sh
        EOF
        chmod +x dist/facepass/install.sh
        cd dist
        tar -czvf facepass-linux-amd64.tar.gz facepass/

    - name: Create DEB Package
      run: |
        set -eux
        VERSION=${GITHUB_REF#refs/tags/v}
        if [[ "$VERSION" == "refs/heads/main" ]] || [[ -z "$VERSION" ]]; then
          VERSION="0.0.0-dev"
        fi
        mkdir -p package/DEBIAN
        mkdir -p package/usr/local/bin
        mkdir -p package/etc/facepass
        mkdir -p package/usr/share/doc/facepass
        cp bin/facepass package/usr/local/bin/
        cp bin/facepass-pam package/usr/local/bin/
        cp configs/facepass.yaml package/etc/facepass/
        cp README.md package/usr/share/doc/facepass/
        cp LICENSE package/usr/share/doc/facepass/
        cat > package/DEBIAN/control <<EOF
        Package: facepass
        Version: ${VERSION}
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: libdlib19, libatlas3-base, liblapack3, libpam0g
        Maintainer: MrCodeEU
        Description: Face Recognition PAM Authentication for Linux
         FacePass is a secure face recognition authentication module for Linux
         that integrates with PAM. It provides a Windows Hello-like experience.
        EOF
        fakeroot dpkg-deb --build package facepass_${VERSION}_amd64.deb

    - name: Create RPM Package
      run: |
        set -eux
        VERSION=${GITHUB_REF#refs/tags/v}
        if [[ "$VERSION" == "refs/heads/main" ]] || [[ -z "$VERSION" ]]; then
          VERSION="0.0.0"
        fi
        
        # Create rpmbuild structure
        mkdir -p rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
        
        # Copy files to BUILD directory for rpmbuild
        mkdir -p rpmbuild/BUILD/facepass-${VERSION}
        cp -r bin rpmbuild/BUILD/facepass-${VERSION}/
        cp -r configs rpmbuild/BUILD/facepass-${VERSION}/
        cp README.md LICENSE rpmbuild/BUILD/facepass-${VERSION}/
        
        # Create spec file with proper paths
        cat > rpmbuild/SPECS/facepass.spec <<EOF
        Name:       facepass
        Version:    ${VERSION}
        Release:    1%{?dist}
        Summary:    Face Recognition PAM Authentication for Linux
        License:    MIT
        URL:        https://github.com/MrCodeEU/facepass
        BuildArch:  x86_64
        
        %description
        FacePass is a secure face recognition authentication module for Linux
        that integrates with PAM. It provides a Windows Hello-like experience.
        
        %install
        mkdir -p %{buildroot}/usr/local/bin
        mkdir -p %{buildroot}/etc/facepass
        mkdir -p %{buildroot}/usr/share/doc/facepass
        
        install -m 755 %{_builddir}/facepass-${VERSION}/bin/facepass %{buildroot}/usr/local/bin/
        install -m 755 %{_builddir}/facepass-${VERSION}/bin/facepass-pam %{buildroot}/usr/local/bin/
        install -m 644 %{_builddir}/facepass-${VERSION}/configs/facepass.yaml %{buildroot}/etc/facepass/
        install -m 644 %{_builddir}/facepass-${VERSION}/README.md %{buildroot}/usr/share/doc/facepass/
        install -m 644 %{_builddir}/facepass-${VERSION}/LICENSE %{buildroot}/usr/share/doc/facepass/
        
        %files
        /usr/local/bin/facepass
        /usr/local/bin/facepass-pam
        /etc/facepass/facepass.yaml
        /usr/share/doc/facepass/README.md
        /usr/share/doc/facepass/LICENSE
        EOF
        
        # Build RPM
        rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/facepass.spec
        
        # Move RPMs to artifacts
        mkdir -p artifacts
        find rpmbuild/RPMS -name '*.rpm' -exec mv {} artifacts/ \; || true

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: facepass-build
        path: |
          dist/facepass-linux-amd64.tar.gz
          facepass_*.deb
          artifacts/*.rpm


